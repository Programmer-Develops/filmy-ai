<!doctype html>
<html>
<head><meta charset="utf-8"/><title>Filmy AI Demo</title></head>
<body>
  <h1>Filmy AI Demo</h1>
  <button id="healthBtn">Check Health</button>
  <pre id="health"></pre>

  <h2>Features</h2>
  <button id="featBtn">Get Features</button>
  <pre id="features"></pre>

  <h2>Upload Video</h2>
  <input type="file" id="videoFile" accept="video/*"/>
  <button id="uploadBtn">Upload</button>
  <pre id="uploadResult"></pre>

    <div id="postUpload" style="display:none;margin-top:1em;">
    <strong>Uploaded video id:</strong> <span id="uploadedId"></span>
    <div style="margin-top:8px;">
      <button id="enhanceBtn">Enhance (upscale)</button>
      <button id="checkStatusBtn">Check Status</button>
      <button id="downloadBtn" style="display:none;margin-left:8px;">Download Edited Video</button>
    </div>
    <div id="statusArea" style="margin-top:8px;"></div>
    <div id="previewArea" style="margin-top:12px;"></div>
  </div>

    <h2>Instruction-driven Editing (AI)</h2>
    <div id="instructionArea" style="margin-top:8px; display:none;">
      <textarea id="instructionText" rows="4" cols="60" placeholder="Describe edits, e.g. 'Remove background noise, stabilize, crop to 16:9 and brighten a bit.'"></textarea>
      <div style="margin-top:6px;">
        <button id="submitInstructionBtn">Submit Instruction</button>
      </div>
      <div id="instructionOps" style="margin-top:8px;"></div>
      <div id="instructionProgress" style="margin-top:8px;color:green;"></div>
    </div>

  <script>
    const apiBase = 'http://localhost:8000/'; // adjust if your API runs elsewhere

    let lastUploadedId = null;
    let lastOutputId = null;
    let ws = null;

    document.getElementById('healthBtn').onclick = async () => {
      const r = await fetch(apiBase + 'api/v1/health');
      document.getElementById('health').textContent = await r.text();
    };

    document.getElementById('featBtn').onclick = async () => {
      const r = await fetch(apiBase + 'api/v1/features');
      document.getElementById('features').textContent = JSON.stringify(await r.json(), null, 2);
    };

    document.getElementById('uploadBtn').onclick = uploadVideo;

    async function uploadVideo(){
      const input = document.getElementById('videoFile');
      if (!input.files.length) return alert('Choose a file');
      const fd = new FormData();
      fd.append('file', input.files[0]);
      try{
        const r = await fetch(apiBase + 'api/v1/upload/video', { method: 'POST', body: fd });
        const json = await r.json();
        document.getElementById('uploadResult').textContent = JSON.stringify(json, null, 2);
        if (json.video_id){
          lastUploadedId = json.video_id;
          document.getElementById('uploadedId').textContent = lastUploadedId;
          document.getElementById('postUpload').style.display = 'block';
        }
      }catch(err){
        alert('Upload failed: ' + err.message);
      }
    }

    document.getElementById('enhanceBtn').onclick = async () => {
      if (!lastUploadedId) return alert('No uploaded video id');
      // send a simple upscale enhancement request
      const payload = {
        video_id: lastUploadedId,
        enhancement_type: 'upscale',
        settings: {}
      };
      try{
        const r = await fetch(apiBase + 'api/v1/enhance/video', { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
        const json = await r.json();
        // server returns output_path; extract filename to use download endpoint
        document.getElementById('statusArea').textContent = JSON.stringify(json, null, 2);
        if (json.output_path){
          const parts = json.output_path.split(/[\\/]/);
          lastOutputId = parts[parts.length-1];
          showPreview(lastOutputId);
        }
      }catch(err){
        alert('Enhance failed: ' + err.message);
      }
    };

    document.getElementById('checkStatusBtn').onclick = async () => {
      const id = lastOutputId || lastUploadedId;
      if (!id) return alert('No video id to check');
      try{
        const r = await fetch(apiBase + 'api/v1/status/' + encodeURIComponent(id));
        const json = await r.json();
        document.getElementById('statusArea').textContent = JSON.stringify(json, null, 2);
      }catch(err){
        alert('Status check failed: ' + err.message);
      }
    };

    function showPreview(outputId){
      const previewArea = document.getElementById('previewArea');
      previewArea.innerHTML = '';
      const dlUrl = apiBase + 'api/v1/download/' + encodeURIComponent(outputId);
      const video = document.createElement('video');
      video.controls = true;
      video.width = 640;
      video.src = dlUrl;
      previewArea.appendChild(video);

      const a = document.createElement('a');
      a.href = dlUrl;
      a.textContent = 'Download processed video';
      a.style.display = 'block';
      a.style.marginTop = '8px';
      previewArea.appendChild(a);

      // Show download button and attach handler
      const dlBtn = document.getElementById('downloadBtn');
      dlBtn.style.display = 'inline-block';
      dlBtn.onclick = () => downloadProcessedVideo(outputId);
    }

    async function downloadProcessedVideo(outputId){
      const dlUrl = apiBase + 'api/v1/download/' + encodeURIComponent(outputId);
      try{
        const resp = await fetch(dlUrl);
        if (!resp.ok) throw new Error('Download failed: ' + resp.statusText);
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = outputId;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }catch(err){
        alert('Download error: ' + err.message);
      }
    }

    // Instruction-driven editing
    document.getElementById('submitInstructionBtn').onclick = async () => {
      const instruction = document.getElementById('instructionText').value.trim();
      if (!instruction) return alert('Enter an instruction');
      if (!lastUploadedId) return alert('Upload a video first');

      document.getElementById('instructionOps').textContent = 'Parsing instruction...';
      try{
        const r = await fetch(apiBase + 'api/v1/instruct', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ video_id: lastUploadedId, instruction })
        });
        const json = await r.json();
        document.getElementById('instructionOps').textContent = JSON.stringify(json.operations || json, null, 2);

        // Open WebSocket to receive progress
        openProgressWebSocket(lastUploadedId);
      }catch(err){
        alert('Instruction submit failed: ' + err.message);
      }
    };

    function openProgressWebSocket(videoId){
      // Close existing ws if open
      if (ws){ try{ ws.close(); }catch(e){} }
      const wsHost = (apiBase.startsWith('https://') ? 'wss://' : 'ws://') + (new URL(apiBase)).host;
      const wsUrl = wsHost + '/ws/progress/' + encodeURIComponent(videoId);
      ws = new WebSocket(wsUrl);
      const prog = document.getElementById('instructionProgress');
      prog.textContent = 'Connecting...';
      ws.onopen = () => { prog.textContent = 'Connected, awaiting progress...'; };
      ws.onmessage = async (ev) => {
        try{
          const data = JSON.parse(ev.data);
          prog.textContent = 'Status: ' + (data.status || JSON.stringify(data));
          if (data.status === 'completed'){
            prog.textContent = 'Processing completed.';
            // attempt to discover output file and preview it
            await discoverAndPreviewOutput(lastUploadedId);
            ws.close();
          }
        }catch(e){
          prog.textContent = ev.data;
        }
      };
      ws.onerror = (e) => { prog.textContent = 'WebSocket error'; };
      ws.onclose = () => { prog.textContent += ' (closed)'; };
    }

    async function discoverAndPreviewOutput(videoId){
      try{
        const r = await fetch(apiBase + 'api/v1/debug/outputs');
        const json = await r.json();
        const files = json.files || [];
        // Prefer files that contain the original uploaded id or the operation name
        let candidate = null;
        for (let f of files.reverse()){
          if (f.includes(videoId) || f.includes('enhance') || f.includes('upscale') || f.includes('edited')){ candidate = f; break; }
        }
        if (!candidate && files.length) candidate = files[files.length-1];
        if (candidate){
          lastOutputId = candidate;
          showPreview(candidate);
        }else{
          alert('No output file found in output directory');
        }
      }catch(err){
        alert('Could not list outputs: ' + err.message);
      }
    }
  </script>
</body>
</html>